<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改密码 - 知识图谱系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/css/auth.css">
    <style>
        /* 密码强度指示器 */
        .password-strength-feedback {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* 密码强度进度条 */
        .progress {
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            height: 6px;
            margin-bottom: 8px;
        }

        .progress-bar {
            transition: width 0.3s ease, background-color 0.3s ease;
            border-radius: 4px;
        }

        /* 验证要求列表 */
        /* 更新验证要求列表样式 */
        .requirement-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            color: #666;
        }

        .requirement-icon {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin-right: 6px;
            border-radius: 50%;
            background-color: #dc3545;
            transition: all 0.3s ease;
        }

        .requirement-item.valid .requirement-icon {
            background-color: #28a745;
        }

        /* 密码强度指示器 */
        .password-strength-feedback {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* 密码强度进度条 */
        .progress {
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            height: 6px;
            margin-bottom: 8px;
        }

        .progress-bar {
            transition: width 0.3s ease, background-color 0.3s ease;
            border-radius: 4px;
        }

        /* 密码强度颜色 */
        .password-weak {
            background-color: #ff4d4f;
        }

        .password-medium {
            background-color: #faad14;
        }

        .password-strong {
            background-color: #52c41a;
        }
    </style>
</head>
<body>
    <div class="auth-container2">
        <div class="auth-card">
            <div class="auth-logo">
                <h3>修改密码</h3>
                <p class="text-muted">请验证身份并设置新密码</p>
            </div>

            <form id="changePasswordForm">
                <div class="alert alert-danger d-none" id="changePasswordError"></div>
                <div class="alert alert-success d-none" id="changePasswordSuccess"></div>

                <div class="form-group">
                    <label for="userId" class="form-label">用户名</label>
                    <input type="text" id="userId" class="form-control" placeholder="请输入用户名" required>
                    <div class="error-message d-none" id="userIdError"></div>
                </div>

                <div class="form-group">
                    <label for="oldPassword" class="form-label">原密码</label>
                    <input type="password" id="oldPassword" class="form-control" placeholder="请输入原密码" required>
                    <div class="error-message d-none" id="oldPasswordError"></div>
                </div>

                <div class="form-group">
                    <label for="newPassword" class="form-label">新密码</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="请输入新密码(8位以上)" required>
                    <div class="password-strength-feedback">
                        <div class="progress">
                            <div id="passwordStrengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="requirement-list">
                            <div class="requirement-item" id="lengthReq">
                                <span class="requirement-icon"></span>
                                <span>至少8个字符</span>
                            </div>
                            <div class="requirement-item" id="upperReq">
                                <span class="requirement-icon"></span>
                                <span>至少1个大写字母</span>
                            </div>
                            <div class="requirement-item" id="numberReq">
                                <span class="requirement-icon"></span>
                                <span>至少1个数字</span>
                            </div>
                        </div>
                    </div>
                    <div class="error-message d-none" id="newPasswordError"></div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword" class="form-label">确认新密码</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="请再次输入新密码" required>
                    <div class="error-message d-none" id="confirmPasswordError"></div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-change auth-btn" >确认修改</button>
                </div>

                <div class="auth-footer">
                    <p class="text-center mt-3">
                        <a href="index.html" class="text-decoration-none">返回登录</a>
                    </p>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 实时密码验证
            document.getElementById('newPassword').addEventListener('input', function() {
                const password = this.value;
                const strengthBar = document.getElementById('passwordStrengthBar');

                // 验证各项要求
                const lengthValid = password.length >= 8;
                const upperValid = /[A-Z]/.test(password);
                const numberValid = /[0-9]/.test(password);

                // 更新验证提示
                updateRequirement('lengthReq', lengthValid);
                updateRequirement('upperReq', upperValid);
                updateRequirement('numberReq', numberValid);

                // 计算密码强度
                let strength = 0;
                if (lengthValid) strength += 33;
                if (upperValid) strength += 33;
                if (numberValid) strength += 34;

                // 更新进度条
                strengthBar.style.width = strength + '%';

                // 根据强度设置颜色
                strengthBar.className = 'progress-bar';
                if (strength < 50) {
                    strengthBar.classList.add('password-weak');
                } else if (strength < 80) {
                    strengthBar.classList.add('password-medium');
                } else {
                    strengthBar.classList.add('password-strong');
                }
            });

            // 更新单个验证要求的显示状态
            function updateRequirement(id, isValid) {
                const element = document.getElementById(id);
                element.classList.toggle('valid', isValid);
                element.classList.toggle('invalid', !isValid && element.textContent.trim().length > 0);
            }

            // 密码验证函数
            function validatePassword(password) {
                const lengthValid = password.length >= 8;
                const upperValid = /[A-Z]/.test(password);
                const numberValid = /[0-9]/.test(password);

                return lengthValid && upperValid && numberValid;
            }

            // 修改密码表单处理
            const changePasswordForm = document.getElementById('changePasswordForm');
            const submitButton = changePasswordForm.querySelector('.auth-btn');

            changePasswordForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // 清除所有错误和成功消息
                document.getElementById('changePasswordError').classList.add('d-none');
                document.getElementById('changePasswordSuccess').classList.add('d-none');
                document.getElementById('userIdError').classList.add('d-none');
                document.getElementById('oldPasswordError').classList.add('d-none');
                document.getElementById('newPasswordError').classList.add('d-none');
                document.getElementById('confirmPasswordError').classList.add('d-none');

                const userId = document.getElementById('userId').value;
                const oldPassword = document.getElementById('oldPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                let isValid = true;

                // 用户名验证
                if (!userId.trim()) {
                    document.getElementById('userIdError').textContent = '请输入用户名';
                    document.getElementById('userIdError').classList.remove('d-none');
                    isValid = false;
                }

                // 原密码验证
                if (!oldPassword) {
                    document.getElementById('oldPasswordError').textContent = '请输入原密码';
                    document.getElementById('oldPasswordError').classList.remove('d-none');
                    isValid = false;
                }

                // 新密码验证
                if (!newPassword) {
                    document.getElementById('newPasswordError').textContent = '请输入新密码';
                    document.getElementById('newPasswordError').classList.remove('d-none');
                    isValid = false;
                } else {
                    const passwordValid = validatePassword(newPassword);
                    if (!passwordValid) {
                        document.getElementById('newPasswordError').textContent = '密码需8位以上且包含大写字母和数字';
                        document.getElementById('newPasswordError').classList.remove('d-none');
                        isValid = false;
                    }
                }

                // 确认密码验证
                if (!confirmPassword) {
                    document.getElementById('confirmPasswordError').textContent = '请确认新密码';
                    document.getElementById('confirmPasswordError').classList.remove('d-none');
                    isValid = false;
                } else if (newPassword !== confirmPassword) {
                    document.getElementById('confirmPasswordError').textContent = '两次输入的密码不一致';
                    document.getElementById('confirmPasswordError').classList.remove('d-none');
                    isValid = false;
                }

                // 如果验证通过，发送修改密码请求
                if (isValid) {
                    try {
                        // 设置按钮为加载状态
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 修改中...';

                        // 发送修改密码请求
                        const response = await fetch('http://127.0.0.1:8000/api/change_password/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: userId,
                                old_password: oldPassword,
                                new_password: newPassword
                            })
                        });

                        const result = await response.json();

                        if (response.ok && result.message === "密码修改成功") {
                            // 修改成功
                            document.getElementById('changePasswordSuccess').textContent = '密码修改成功，请使用新密码登录';
                            document.getElementById('changePasswordSuccess').classList.remove('d-none');

                            // 清空表单
                            changePasswordForm.reset();

                            // 3秒后跳转到登录页面
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 3000);
                        } else {
                            // 显示服务器返回的错误信息
                            const errorMsg = result.error || '密码修改失败，请重试';
                            document.getElementById('changePasswordError').textContent = errorMsg;
                            document.getElementById('changePasswordError').classList.remove('d-none');

                            // 重置按钮状态
                            submitButton.disabled = false;
                            submitButton.textContent = '确认修改';
                        }
                    } catch (error) {
                        console.error('修改密码请求失败:', error);
                        document.getElementById('changePasswordError').textContent = '网络错误，请检查连接';
                        document.getElementById('changePasswordError').classList.remove('d-none');

                        // 重置按钮状态
                        submitButton.disabled = false;
                        submitButton.textContent = '确认修改';
                    }
                }
            });

            // 如果从登录页面跳转过来，可以自动填充用户名
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');
            if (username) {
                document.getElementById('userId').value = username;
            }
        });
    </script>
</body>
</html>