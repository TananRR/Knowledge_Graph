<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册 - 知识图谱系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/css/auth.css">
    <style>
        /* 自定义样式 - 极简白色弹窗 */
        #messageModal .modal-content {
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        #messageModal .modal-header {
            border-bottom: none;
            padding-bottom: 0;
            background: white;
        }
        #messageModal .modal-title {
            font-weight: normal;
            color: #333;
        }
        #messageModal .modal-body {
            padding-top: 0;
            color: #555;
        }
        #messageModal .modal-footer {
            border-top: none;
            padding-top: 0;
            background: white;
        }
        #messageModal .btn-close {
            display: none; /* 隐藏关闭按钮 */
        }
        #messageModal .btn-confirm {
            background: #f0f0f0;
            border: none;
            color: #333;
            padding: 5px 15px;
            border-radius: 4px;
        }

        /* 验证提示样式保持原样 */
        .requirement-list {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .requirement-item {
            display: flex;
            align-items: center;
        }
        .requirement-icon {
            margin-right: 0.3rem;
            font-size: 0.7rem;
        }
        .valid {
            color: #28a745;
        }
        .invalid {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- 极简白色弹窗 -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="modalTitle">提示</h6>
                </div>
                <div class="modal-body" id="modalMessage">
                    <!-- 消息内容将在这里显示 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-confirm" data-bs-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 以下是原有页面内容，完全保持不变 -->
    <div class="vertical-typing-container">
        <div class="typing-left" id="typingLeft"></div>
        <div class="typing-right" id="typingText"></div>
    </div>

    <div class="auth-container1">
        <div class="auth-card">
            <div class="auth-logo">
                <h3>创建新账号</h3>
                <p class="text-muted">加入知识图谱系统</p>
            </div>

            <form id="registerForm">
                <div class="form-group mb-3">
                    <label for="registerUsername" class="form-label">用户名</label>
                    <input type="text" id="registerUsername" class="form-control" placeholder="请输入用户名(3-20位字母或数字)" required>
                    <div class="requirement-list mt-1">
                        <div class="requirement-item" id="usernameLengthReq">
                            <span class="requirement-icon">•</span>
                            <span>3-20字符</span>
                        </div>
                        <div class="requirement-item" id="usernameCharReq">
                            <span class="requirement-icon">•</span>
                            <span>字母/数字/下划线</span>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="registerPassword" class="form-label">密码</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="请输入密码(8位以上)" required>
                    <div class="requirement-list mt-1">
                        <div class="requirement-item" id="lengthReq">
                            <span class="requirement-icon">•</span>
                            <span>≥8位</span>
                        </div>
                        <div class="requirement-item" id="upperReq">
                            <span class="requirement-icon">•</span>
                            <span>含大写字母</span>
                        </div>
                        <div class="requirement-item" id="numberReq">
                            <span class="requirement-icon">•</span>
                            <span>含数字</span>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="registerPasswordConfirm" class="form-label">确认密码</label>
                    <input type="password" id="registerPasswordConfirm" class="form-control" placeholder="请再次输入密码" required>
                </div>

                <div class="form-group form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="acceptTerms" required>
                    <label class="form-check-label" for="acceptTerms">
                        我已阅读并同意<a href="#" class="text-decoration-none">服务条款</a>和<a href="#" class="text-decoration-none">隐私政策</a>
                    </label>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-success auth-btn">注册</button>
                </div>

                <div class="auth-footer">
                    <p class="text-center mt-3">
                        已有账号? <a href="index.html" class="text-decoration-none">立即登录</a>
                    </p>
                </div>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化弹窗
            const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));

            // 显示消息的函数（极简版）
            function showMessage(title, message) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                messageModal.show();
            }

            // 保持原有的打字动画、验证逻辑和表单处理代码
            // ...（原有代码完全保持不变）...

            // 垂直打字动画
            const textLeft = "请 您 创 建";
            const textRight = "新 的 账 号";
            const typingLeftElement = document.getElementById('typingLeft');
            const typingRightElement = document.getElementById('typingText');

            function typeVertical(element, text, speed, callback) {
                const lines = text.split('\n');
                let i = 0, j = 0;

                function typeLine() {
                    if (i < lines.length) {
                        if (j <= lines[i].length) {
                            element.innerHTML = lines.slice(0, i).join('<br>') +
                                            '<br>' + lines[i].substring(0, j);
                            j++;
                            setTimeout(typeLine, speed);
                        } else {
                            i++;
                            j = 0;
                            element.innerHTML = lines.slice(0, i).join('<br>');
                            if (i < lines.length) {
                                setTimeout(typeLine, speed * 2);
                            } else if (callback) {
                                callback();
                            }
                        }
                    }
                }
                typeLine();
            }

            // 启动打字动画
            typeVertical(typingLeftElement, textLeft, 150, function() {
                setTimeout(() => {
                    typeVertical(typingRightElement, textRight, 150);
                }, 300);
            });

            // 实时用户名验证
            document.getElementById('registerUsername').addEventListener('input', function() {
                const username = this.value;
                const lengthReq = document.getElementById('usernameLengthReq');
                const charReq = document.getElementById('usernameCharReq');

                // 验证长度
                if (username.length === 0) {
                    lengthReq.classList.remove('valid', 'invalid');
                    charReq.classList.remove('valid', 'invalid');
                } else {
                    const lengthValid = username.length >= 3 && username.length <= 20;
                    lengthReq.classList.toggle('valid', lengthValid);
                    lengthReq.classList.toggle('invalid', !lengthValid);

                    // 验证字符
                    const charValid = /^[a-zA-Z0-9_]+$/.test(username);
                    charReq.classList.toggle('valid', charValid);
                    charReq.classList.toggle('invalid', !charValid);
                }
            });

            // 实时密码验证
            document.getElementById('registerPassword').addEventListener('input', function() {
                validatePassword(this.value);
            });

            // 密码验证函数
            function validatePassword(password) {
                const lengthValid = password.length >= 8;
                const upperValid = /[A-Z]/.test(password);
                const numberValid = /[0-9]/.test(password);

                // 更新密码要求提示
                document.getElementById('lengthReq').classList.toggle('valid', lengthValid);
                document.getElementById('upperReq').classList.toggle('valid', upperValid);
                document.getElementById('numberReq').classList.toggle('valid', numberValid);
                document.getElementById('lengthReq').classList.toggle('invalid', !lengthValid && password.length > 0);
                document.getElementById('upperReq').classList.toggle('invalid', !upperValid && password.length > 0);
                document.getElementById('numberReq').classList.toggle('invalid', !numberValid && password.length > 0);

                return lengthValid && upperValid && numberValid;
            }

            // 注册表单处理
            const registerForm = document.getElementById('registerForm');
            const submitButton = registerForm.querySelector('.auth-btn');

            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // 获取表单数据
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value;
                const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
                const acceptTerms = document.getElementById('acceptTerms').checked;

                // 表单验证标志
                let isValid = true;
                let errorMessages = [];

                // 用户名验证
                if (!username) {
                    errorMessages.push('请输入用户名');
                    isValid = false;
                } else {
                    const lengthValid = username.length >= 3 && username.length <= 20;
                    const charValid = /^[a-zA-Z0-9_]+$/.test(username);

                    if (!lengthValid) {
                        errorMessages.push('用户名长度需为3-20个字符');
                        isValid = false;
                    }
                    if (!charValid) {
                        errorMessages.push('用户名只能包含字母、数字和下划线');
                        isValid = false;
                    }
                }

                // 密码验证
                if (!password) {
                    errorMessages.push('请输入密码');
                    isValid = false;
                } else {
                    const passwordValid = validatePassword(password);
                    if (!passwordValid) {
                        errorMessages.push('密码需8位以上且包含大写字母和数字');
                        isValid = false;
                    }
                }

                // 确认密码验证
                if (!passwordConfirm) {
                    errorMessages.push('请确认密码');
                    isValid = false;
                } else if (password !== passwordConfirm) {
                    errorMessages.push('两次输入的密码不一致');
                    isValid = false;
                }

                // 条款同意验证
                if (!acceptTerms) {
                    errorMessages.push('请接受服务条款和隐私政策');
                    isValid = false;
                }

                // 如果验证通过，发送注册请求
                if (isValid) {
                    try {
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 注册中...';

                        const response = await fetch('http://127.0.0.1:8000/api/register/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: username,
                                password: password
                            })
                        });

                        const result = await response.json();

                        if (response.ok && result.message === "注册成功") {
                            showMessage('注册成功', '注册成功！即将跳转到登录页面...');

                            setTimeout(() => {
                                window.location.href = `index.html?registered_user=${encodeURIComponent(username)}`;
                            }, 3000);
                        } else {
                            const errorMsg = result.error || '注册失败，请重试';
                            showMessage('注册失败', errorMsg);
                            submitButton.disabled = false;
                            submitButton.textContent = '注册';
                        }
                    } catch (error) {
                        showMessage('网络错误', '网络错误，请检查连接');
                        submitButton.disabled = false;
                        submitButton.textContent = '注册';
                    }
                } else {
                    showMessage('注册失败', errorMessages.join('；'));
                }
            });
        });
    </script>
</body>
</html>